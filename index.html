<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Einsatzprotokoll – Freiwillige Feuerwehr Kamernstedt</title>

  <!-- jsPDF für PDF-Export -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js" defer></script>

  <style>
    :root{
      --bg:#0b1220; --card:#0f172a; --txt:#e5e7eb; --muted:#94a3b8; --pri:#22c55e; --bd:#1f2a44;
      --input-bg:#0b1220; --btn-txt:#0b1220; --badge-bg:#112033; --badge-txt:#8ab4ff; --shadow:none
    }
    @media (prefers-color-scheme: light){
      :root{
        --bg:#f7f7fb; --card:#fff; --txt:#0f172a; --muted:#64748b; --pri:#0ea5e9; --bd:#e5e7eb;
        --input-bg:#fff; --btn-txt:#fff; --badge-bg:#eef2ff; --badge-txt:#3730a3; --shadow:0 1px 2px rgba(0,0,0,.06)
      }
    }

    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--txt);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    .wrap{max-width:1100px;margin:0 auto;padding:20px}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:14px}
    header h1{font-size:20px;margin:0}
    header img{height:34px}
    .row{display:grid;grid-template-columns:1fr;gap:14px}
    @media(min-width:900px){.row{grid-template-columns:1fr 1fr}}
    .card{background:var(--card);border:1px solid var(--bd);border-radius:16px;padding:16px;box-shadow:var(--shadow)}
    .card h2{margin:0 0 10px;font-size:18px}
    .grid{display:grid;grid-template-columns:1fr;gap:10px}
    .grid.two{grid-template-columns:1fr 1fr;gap:10px}
    label{font-size:13px}
    input[type="text"], textarea, select{
      width:100%;background:var(--input-bg);color:var(--txt);border:1px solid var(--bd);
      border-radius:12px;padding:10px 12px;font-size:14px;outline:none
    }
    textarea{resize:vertical;min-height:90px}
    .muted{color:var(--muted);font-size:13px}
    .btn{cursor:pointer;border:0;border-radius:12px;font-weight:600;padding:10px 14px;background:var(--pri);color:var(--btn-txt)}
    .btn-outline{background:transparent;color:var(--txt);border:1px solid var(--bd)}
    .btn.small{padding:6px 10px;font-size:13px}
    .stack{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .table-head{display:grid;grid-template-columns:48px 1fr 1fr 1fr 38px;gap:10px;font-size:13px;color:var(--muted);margin:8px 0}
    .table-row{display:grid;grid-template-columns:48px 1fr 1fr 1fr 38px;gap:10px;margin-bottom:6px}
    .badge{display:inline-block;background:var(--badge-bg);color:var(--badge-txt);border-radius:999px;padding:2px 8px;font-size:12px}
    .hr{height:1px;background:var(--bd);margin:10px 0}
    .icon-btn{display:inline-flex;align-items:center;justify-content:center;width:32px;height:32px;border:1px solid var(--bd);border-radius:10px;background:transparent;cursor:pointer}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="stack">
        <img src="FF%20Logo.png" alt="Logo" onerror="this.style.display='none'">
        <h1>Einsatzprotokoll der Freiwilligen Feuerwehr Kamernstedt</h1>
      </div>
      <div class="stack">
        <button type="button" class="btn-outline btn" id="btnReset">Zurücksetzen</button>
        <button type="button" class="btn" id="btnPdf">PDF erstellen</button>
      </div>
    </header>

    <div class="row">
      <!-- Allgemein -->
      <section class="card">
        <h2>Allgemein</h2>
        <div class="grid two">
          <div><label>Datum</label><input id="datum" type="text" placeholder="YYYY-MM-DD"></div>
          <div><label>Uhrzeit</label><input id="uhrzeit" type="text" placeholder="HH:MM"></div>
          <div><label>Fahrzeug</label><input id="fahrzeug" type="text" placeholder="z. B. LF 10"></div>
          <div><label>Fahrzeugführer</label><input id="fahrzeugfuehrer" type="text"></div>
          <div><label>Stichwort</label><input id="stichwort" type="text" placeholder="z. B. BMA, THY …"></div>
          <div><label>Einsatznummer</label><input id="einsatznummer" type="text"></div>
        </div>
      </section>

      <!-- Einsatzzeiten -->
      <section class="card">
        <h2>Einsatzzeiten <span class="badge" id="dauerBadge"></span></h2>
        <div class="grid two">
          <div><label>Einsatzbeginn (YYYY-MM-DD HH:MM)</label><input id="einsatzbeginn" type="text" placeholder="YYYY-MM-DD HH:MM"></div>
          <div><label>Einsatzende (YYYY-MM-DD HH:MM)</label><input id="einsatzende" type="text" placeholder="YYYY-MM-DD HH:MM"></div>
        </div>
        <div class="stack" style="margin-top:10px">
          <button type="button" class="btn-outline btn small" id="btnStart">Start jetzt</button>
          <button type="button" class="btn small" id="btnEnd">Einsatz beendet</button>
        </div>
      </section>

      <!-- Einsatzdaten -->
      <section class="card">
        <h2>Einsatzdaten</h2>
        <div class="grid two">
          <div><label>Wo</label><input id="ort" type="text"></div>
          <div><label>Was</label><input id="was" type="text"></div>
          <div><label>Übergabe an</label><input id="uebergabeAn" type="text"></div>
          <div><label>Übergabe Uhrzeit</label><input id="uebergabeUhrzeit" type="text" placeholder="HH:MM"></div>
        </div>
      </section>

      <!-- Lage -->
      <section class="card" style="grid-column:1/-1">
        <h2>Vorgefundene Lage</h2>
        <textarea id="lage" placeholder="Kurzbeschreibung der Lage vor Ort"></textarea>
      </section>

      <!-- Maßnahmen -->
      <section class="card" style="grid-column:1/-1">
        <h2>Maßnahmen</h2>
        <textarea id="massnahmen" placeholder="Getroffene Maßnahmen, Besonderheiten, Gefahren"></textarea>
      </section>

      <!-- Mannschaft -->
      <section class="card" style="grid-column:1/-1">
        <h2>Mannschaftsstärke</h2>
        <div class="grid two">
          <div><label>Anzahl</label><input id="mannschaftsstaerke" type="text" placeholder="z. B. 1/8"></div>
        </div>
        <div class="table-head">
          <div>Nr.</div><div>Name</div><div>Funktion</div><div>Fahrzeug</div><div></div>
        </div>
        <div id="mannList"></div>
        <div class="stack"><button type="button" class="btn-outline btn small" id="btnAddPerson">+ Person hinzufügen</button></div>
      </section>

      <!-- Weitere Fahrzeuge -->
      <section class="card" style="grid-column:1/-1">
        <h2>Weitere Fahrzeuge der Wehr</h2>
        <label class="stack"><input id="weitereEnable" type="checkbox"> Weitere Fahrzeuge beteiligt?</label>
        <div id="weitereWrap" style="display:none">
          <div id="weitereList"></div>
          <div class="stack"><button type="button" class="btn-outline btn small" id="btnAddFzg">+ Fahrzeug hinzufügen</button></div>
        </div>
      </section>

      <!-- Externe Kräfte -->
      <section class="card" style="grid-column:1/-1">
        <h2>Nachalarmierte externe Kräfte</h2>
        <label class="stack"><input id="externEnable" type="checkbox"> Externe Kräfte beteiligt?</label>
        <div id="externWrap" style="display:none;margin-top:10px">
          <div class="grid two" id="externList"></div>
          <div class="hr"></div>
          <div class="stack">
            <label class="stack"><input type="radio" name="extMode" value="selected" checked> Nur ausgewählte auflisten</label>
            <label class="stack"><input type="radio" name="extMode" value="all"> Alle anzeigen (☑/☐)</label>
          </div>
        </div>
      </section>

      <!-- Nachbereitung -->
      <section class="card" style="grid-column:1/-1">
        <h2>Nachbereitung</h2>
        <div class="grid two">
          <label class="stack"><input id="nb_nachb" type="checkbox"> Nachbesprechung erforderlich</label>
          <label class="stack"><input id="nb_reini" type="checkbox"> Reinigung / Wartung erforderlich</label>
        </div>
        <div class="grid two" style="margin-top:10px">
          <div><label>Bemerkungen</label><textarea id="nb_bem"></textarea></div>
          <div><label>Material / Schäden</label><textarea id="nb_mat"></textarea></div>
        </div>
      </section>
    </div>
  </div>

<script>
const $ = (id) => document.getElementById(id);
const pad = (n) => String(n).padStart(2,'0');
const nowLocal = () => { const n=new Date(); const d=`${n.getFullYear()}-${pad(n.getMonth()+1)}-${pad(n.getDate())}`; const t=`${pad(n.getHours())}:${pad(n.getMinutes())}`; return {date:d,time:t,stamp:`${d} ${t}`}; };
const parseStamp = (s)=> new Date(String(s).replace(' ','T'));
const formatDuration = (start,end)=>{ if(!start) return '-'; const a=parseStamp(start).getTime(), b=end?parseStamp(end).getTime():Date.now(); const diff=Math.max(0,b-a), m=Math.floor(diff/60000); return `${Math.floor(m/60)} Std. ${m%60} Min.`; };

// ====== FUNKTIONEN + Priorität ======
const FUNKTIONEN = ["Fahrzeugführer","Maschinist","ATF","ATM","WTF","WTM","STF","STM","Melder"];
const FUNKTION_PRIOR = {"Fahrzeugführer":1,"Maschinist":2,"ATF":3,"ATM":4,"WTF":5,"WTM":6,"STF":7,"STM":8,"Melder":9};
const buildFunktionSelect = (selected="") =>
  `<select class="funktion">` + FUNKTIONEN.map(f=>`<option value="${f}" ${f===selected?'selected':''}>${f}</option>`).join('') + `</select>`;

// ====== INIT ======
function init(){
  // Zeit + Dauer live
  const n=nowLocal();
  $('datum').value=n.date; $('uhrzeit').value=n.time;
  $('einsatzbeginn').value=`${n.date} ${n.time}`; updateDauer();
  setInterval(()=>{ const k=nowLocal(); $('datum').value=k.date; $('uhrzeit').value=k.time; updateDauer(); }, 1000);

  // Buttons
  $('btnStart').addEventListener('click', ()=>{ const n=nowLocal(); $('einsatzbeginn').value=`${n.date} ${n.time}`; updateDauer(); });
  $('btnEnd').addEventListener('click', ()=>{ const n=nowLocal(); $('einsatzende').value=`${n.date} ${n.time}`; updateDauer(); });
  $('btnReset').addEventListener('click', resetAll);
  $('btnPdf').addEventListener('click', generatePDF);

  // Mannschaft
  $('btnAddPerson').addEventListener('click', () => { addPerson(); });
  $('mannList').addEventListener('click', (e)=>{
    const btn = e.target.closest && e.target.closest('[data-remove-person]');
    if(!btn) return;
    e.preventDefault();
    const row = btn.closest('.table-row'); if(row){ row.remove(); sortMannschaft(); }
  });
  $('mannList').addEventListener('change', (e) => {
    if (e.target && (e.target.classList.contains('name') || e.target.classList.contains('funktion'))) {
      sortMannschaft();
    }
  });

  // Erste Zeile anlegen
  if (!$('mannList').children.length) addPerson();

  // Weitere Fahrzeuge
  $('weitereEnable').addEventListener('change', ()=> toggleDisplay('weitereWrap', $('weitereEnable').checked));
  $('btnAddFzg').addEventListener('click', addWeiteres);
  addWeiteres(); toggleDisplay('weitereWrap', false);

  // Externe
  $('externEnable').addEventListener('change', ()=> toggleDisplay('externWrap', $('externEnable').checked));
  buildExternList(); toggleDisplay('externWrap', false);
}

// sicherstellen, dass init wirklich läuft
window.addEventListener('DOMContentLoaded', () => {
  try { init(); } catch (e){ console.error('Init-Fehler:', e); }
});

// Fallback-Delegation falls ein Listener fehlt
document.addEventListener('click', function (e) {
  const el = e.target && (e.target.id === 'btnAddPerson' ? e.target : (e.target.closest ? e.target.closest('#btnAddPerson') : null));
  if (!el) return;
  e.preventDefault();
  try { addPerson(); } catch (err) { console.error('addPerson() Fehler:', err); }
});

function toggleDisplay(id, on){ $(id).style.display = on ? 'block' : 'none'; }
function updateDauer(){ $('dauerBadge').textContent = `Dauer: ${formatDuration($('einsatzbeginn').value, $('einsatzende').value)}`; }

// ===== Mannschaft =====
function addPerson(){
  const idx = $('mannList').children.length + 1;
  const row = document.createElement('div');
  row.className='table-row';
  row.innerHTML = `
    <div class="muted" data-num style="padding-top:8px">${idx}</div>
    <input type="text" placeholder="Name" class="name">
    ${buildFunktionSelect()}
    <input type="text" placeholder="Fahrzeug (z. B. LF 10)" class="fzg">
    <button type="button" class="icon-btn" title="Person entfernen" data-remove-person>–</button>
  `;
  $('mannList').appendChild(row);
  sortMannschaft();
}
function renumberRows(){
  Array.prototype.forEach.call($('mannList').querySelectorAll('[data-num]'), (el,i)=> el.textContent = String(i+1));
}
function refreshMannCount(){
  const rows = $('mannList').children.length;
  const inp = $('mannschaftsstaerke');
  const v = (inp.value || '').trim();
  const m = v.match(/^(\d+)(\/\d+)?$/);
  if (m) inp.value = (m[2] ? `${rows}${m[2]}` : String(rows));
}
function sortMannschaft() {
  const list = $('mannList');
  const rows = Array.prototype.slice.call(list.children);

  rows.sort((a, b) => {
    const fa = (a.querySelector('.funktion').value || '').trim();
    const fb = (b.querySelector('.funktion').value || '').trim();
    const pa = FUNKTION_PRIOR[fa] || 999;
    const pb = FUNKTION_PRIOR[fb] || 999;

    if (pa !== pb) return pa - pb;

    const na = (a.querySelector('.name').value || '').toLocaleLowerCase('de');
    const nb = (b.querySelector('.name').value || '').toLocaleLowerCase('de');
    return na.localeCompare(nb, 'de');
  });

  rows.forEach(function(r){ list.appendChild(r); });
  renumberRows();
  refreshMannCount();
}

// ===== Weitere Fahrzeuge =====
function addWeiteres(){
  const r=document.createElement('div'); r.className='grid two'; r.style.marginBottom='6px';
  r.innerHTML=`<input type="text" placeholder="Fahrzeug (z. B. LF 10)" class="wfz">
               <input type="text" placeholder="Besatzung (z. B. 1/5)" class="wbes">`;
  $('weitereList').appendChild(r);
}

// ===== Externe =====
function buildExternList(){
  const names=[
    "Berufsfeuerwehr Kamernstedt","Hilfswerk Kamernstedt","Kamernstedter Rettungsdienst",
    "Landespolizei Kamernstedt","Kriminalpolizei Kamernstedt","Ordnungsdienst Kamernstedt",
    "Abschleppdienst","Stadtwerke"
  ];
  $('externList').innerHTML = names.map(n => `
    <label class="stack"><input type="checkbox" data-ext="${n}"><span>${n}</span></label>
  `).join('');
}
function extMode(){ const r=document.querySelector('input[name="extMode"]:checked'); return r? r.value : 'selected'; }
function selectedExtern(){ return Array.prototype.slice.call(document.querySelectorAll('[data-ext]')).filter(i=>i.checked).map(i=>i.getAttribute('data-ext')); }

// ===== Reset =====
function resetAll(){
  const n=nowLocal();
  Array.prototype.forEach.call(document.querySelectorAll('input[type="text"], textarea'), el=>el.value='');
  $('datum').value=n.date; $('uhrzeit').value=n.time;
  $('einsatzbeginn').value=`${n.date} ${n.time}`; $('einsatzende').value='';
  $('nb_nachb').checked=false; $('nb_reini').checked=false;
  $('mannList').innerHTML=''; addPerson(); renumberRows(); refreshMannCount();
  $('weitereList').innerHTML=''; addWeiteres();
  $('externEnable').checked=false; toggleDisplay('externWrap', false);
  $('weitereEnable').checked=false; toggleDisplay('weitereWrap', false);
  Array.prototype.forEach.call(document.querySelectorAll('[data-ext]'), c=>c.checked=false);
  updateDauer();
}

// ===== PDF Export =====
async function generatePDF(){
  sortMannschaft();

  if (!window.jspdf || !window.jspdf.jsPDF){
    alert('PDF-Bibliothek konnte nicht geladen werden.');
    return;
  }
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({unit:'pt',format:'a4'});
  const W = doc.internal.pageSize.getWidth(), H = doc.internal.pageSize.getHeight();
  const margin=48; let y=64;

  const line = (yy)=>doc.line(margin,yy,W-margin,yy);
  const field = (label,value,lw=160)=>{ doc.setFontSize(11); doc.setFont('Helvetica','bold'); doc.text(String(label)+':',margin,y); doc.setFont('Helvetica','normal'); doc.text(String(value||'-'),margin+lw,y); y+=18; };
  const multi = (title,text,maxW,lh=14)=>{ doc.setFontSize(13); doc.setFont('Helvetica','bold'); doc.text(String(title),margin,y); y+=12; line(y); y+=12; const lines=doc.splitTextToSize(String(text||'-'),maxW); doc.setFont('Helvetica','normal'); lines.forEach(function(ln){ if(y>H-72){doc.addPage(); y=72;} doc.text(ln,margin,y); y+=lh; }); };

  // Logo (optional)
  try{
    const r = await fetch('FF%20Logo.png'); if(r.ok){ const b=await r.blob(); const rd=new FileReader(); const dataUrl=await new Promise(function(res){rd.onload=()=>res(rd.result); rd.readAsDataURL(b);}); doc.addImage(String(dataUrl),'PNG',margin,36,24,24); }
  }catch{}

  // Header
  doc.setFont('Helvetica','bold'); doc.setFontSize(14);
  doc.text('Einsatzprotokoll der Freiwilligen Feuerwehr Kamernstedt', margin+40, y);
  y+=10; line(y); y+=16;

  // Allgemein
  doc.setFontSize(13); doc.text('Allgemein', margin, y); y+=12; line(y); y+=12;
  field('Datum', $('datum').value);
  field('Uhrzeit', $('uhrzeit').value);
  field('Fahrzeug', $('fahrzeug').value);
  field('Fahrzeugführer', $('fahrzeugfuehrer').value);
  field('Stichwort', $('stichwort').value);
  field('Einsatznummer', $('einsatznummer').value);

  // Zeiten
  y+=6; doc.setFontSize(13); doc.text('Einsatzzeiten', margin, y); y+=12; line(y); y+=12;
  field('Einsatzbeginn', $('einsatzbeginn').value);
  field('Einsatzende', $('einsatzende').value||'(läuft)');
  field('Dauer', formatDuration($('einsatzbeginn').value, $('einsatzende').value));

  // Einsatzdaten
  y+=6; doc.setFontSize(13); doc.text('Einsatzdaten', margin, y); y+=12; line(y); y+=12;
  field('Wo', $('ort').value, 70);
  field('Was', $('was').value, 70);
  multi('Vorgefundene Lage', $('lage').value, W-margin*2); y+=6;
  multi('Maßnahmen', $('massnahmen').value, W-margin*2);

  // Übergabe
  y+=6; doc.setFontSize(13); doc.text('Übergabe', margin, y); y+=12; line(y); y+=12;
  field('Einsatzstelle übergeben an', $('uebergabeAn').value, 210);
  field('um', $('uebergabeUhrzeit').value, 70);

  // Externe
  if($('externEnable').checked){
    y+=6; doc.setFontSize(13); doc.text('Nachalarmierte externe Kräfte', margin, y); y+=12; line(y); y+=12;
    const mode = extMode();
    const all = Array.prototype.slice.call(document.querySelectorAll('[data-ext]'));
    const sel = selectedExtern();
    if(mode==='selected'){
      if(sel.length===0) field('Ausgewählt','Keine Auswahl');
      else sel.forEach(function(n){ field('•', n, 20); });
    } else {
      all.forEach(function(i){ const mark=i.checked?'☑':'☐'; field(mark, i.getAttribute('data-ext'), 20); });
    }
  }

  // Weitere Fahrzeuge
  if($('weitereEnable').checked){
    y+=6; doc.setFontSize(13); doc.text('Weitere Fahrzeuge der Wehr', margin, y); y+=12; line(y); y+=12;
    const rows = Array.prototype.slice.call($('weitereList').querySelectorAll('.grid.two'));
    const filled = rows.map(function(r){ return {fz:(r.querySelector('.wfz')||{}).value||'', be:(r.querySelector('.wbes')||{}).value||''}; }).filter(function(x){ return (x.fz||'').trim() || (x.be||'').trim(); });
    if(filled.length===0) field('Angaben','Keine weiteren Fahrzeuge'); else filled.forEach(function(x){ field('•', `${x.fz} – Besatzung ${x.be}`, 20); });
  }

  // Mannschaft
  y+=6; doc.setFontSize(13); doc.text('Mannschaftsstärke', margin, y); y+=12; line(y); y+=12;
  field('Anzahl', $('mannschaftsstaerke').value, 70);
  doc.setFont('Helvetica','bold'); doc.setFontSize(12);
  doc.text('Nr.', margin, y); doc.text('Name', margin+40, y); doc.text('Funktion', margin+260, y); doc.text('Fahrzeug', margin+420, y);
  y+=10; line(y); y+=10; doc.setFont('Helvetica','normal');
  Array.prototype.slice.call($('mannList').children).forEach(function(row,i){
    if(y>H-72){ doc.addPage(); y=72; }
    const name=(row.querySelector('.name')||{}).value||'-';
    const fun=(row.querySelector('.funktion')||{}).value||'-';
    const fzg=(row.querySelector('.fzg')||{}).value||'-';
    doc.text(String(i+1), margin, y);
    doc.text(name, margin+40, y);
    doc.text(fun, margin+260, y);
    doc.text(fzg, margin+420, y);
    y+=18;
  });

  // Nachbereitung + extra Abstände
  y+=6; doc.setFontSize(13); doc.text('Nachbereitung', margin, y); y+=12; line(y); y+=12;
  field('Nachbesprechung erforderlich', $('nb_nachb').checked?'Ja':'Nein');
  y+=6;
  field('Reinigung/Wartung erforderlich', $('nb_reini').checked?'Ja':'Nein');
  y+=12;
  multi('Bemerkungen', $('nb_bem').value, W-margin*2);
  y+=12;
  multi('Material/Schäden', $('nb_mat').value, W-margin*2);

  const stich = ($('stichwort').value || "Einsatz").trim().replace(/[^a-zA-Z0-9]+/g, "-");
  const dat = ($('datum').value || "").trim().replace(/[^0-9-]/g, "");
  const time = ($('uhrzeit').value || "").trim().replace(/[^0-9-]/g, "");
  const num = ($('einsatznummer').value || "").trim().replace(/[^a-zA-Z0-9]/g, "");
  const fn = `Einsatz_${stich}${dat ? "_" + dat : ""}${time ? "_" + time : ""}${num ? "_" + num : ""}.pdf`;
  doc.save(fn);
}
</script>
</body>
</html>
